<div class="flex items-center gap-2">
	<label
		for="highlight-theme"
		class="text-xs text-neutral-500 dark:text-neutral-400"
	>
		Theme:
	</label>
	<select
		id="highlight-theme"
		class="text-xs bg-transparent border-none focus:ring-0 text-neutral-700 dark:text-neutral-300 cursor-pointer"
	>
		<optgroup label="Highlight.js Themes">
			<option value="github">GitHub</option>
			<option value="github-dark">GitHub Dark</option>
			<option value="github-dark-dimmed">GitHub Dark Dimmed</option>
			<option value="atom-one-dark">Atom One Dark</option>
			<option value="atom-one-light">Atom One Light</option>
			<option value="monokai">Monokai</option>
			<option value="monokai-sublime">Monokai Sublime</option>
			<option value="dracula">Dracula</option>
			<option value="nord">Nord</option>
			<option value="night-owl">Night Owl</option>
			<option value="tokyo-night-dark">Tokyo Night Dark</option>
			<option value="stackoverflow-dark">Stack Overflow Dark</option>
			<option value="stackoverflow-light">Stack Overflow Light</option>
			<option value="vs">VS</option>
			<option value="vs2015">VS 2015</option>
		</optgroup>
	</select>
</div>

<script>
	function initThemeSelect() {
		const themeSelect = document.getElementById(
			"highlight-theme",
		) as HTMLSelectElement;

		let themeStyle = document.getElementById(
			"highlight-theme-style",
		) as HTMLStyleElement;

		if (!themeStyle) {
			themeStyle = document.createElement("style");
			themeStyle.id = "highlight-theme-style";
			document.head.appendChild(themeStyle);
		}

		const THEME_STORAGE_KEY = "highlight_theme";

		// Load saved theme
		const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || "github";
		if (themeSelect) themeSelect.value = savedTheme;
		updateHighlightTheme(savedTheme, themeStyle);

		themeSelect?.addEventListener("change", (e) => {
			const theme = (e.target as HTMLSelectElement).value;
			localStorage.setItem(THEME_STORAGE_KEY, theme);
			updateHighlightTheme(theme, themeStyle);
		});
	}

	async function updateHighlightTheme(
		theme: string,
		themeStyle: HTMLStyleElement,
	) {
		const themes = import.meta.glob(
			["/node_modules/highlight.js/styles/*.css"],
			{ query: "?raw", eager: true },
		);

		const themeKey = `/node_modules/highlight.js/styles/${theme}.css`;

		const cssModule = themes[themeKey] as { default: string } | undefined;
		if (cssModule) {
			themeStyle.textContent = cssModule.default;
		} else {
			console.error(`Theme not found: ${themeKey}`);
			const defaultTheme = themes[
				"/node_modules/highlight.js/styles/github.css"
			] as
				| { default: string }
				| undefined;
			if (defaultTheme) {
				themeStyle.textContent = defaultTheme.default;
			}
		}
	}

	initThemeSelect();
	document.addEventListener("astro:page-load", initThemeSelect);
</script>
